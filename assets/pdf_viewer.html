<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Jacques PDF Viewer</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css"
    />
    <style>
      :root {
        color-scheme: light;
      }
      body {
        margin: 0;
        font-family: "Spline Sans Mono", monospace;
        background: #f4f6f9;
        color: #1f2937;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      #toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.95);
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      }
      #toolbar button {
        background: linear-gradient(135deg, rgba(28, 110, 111, 0.95), rgba(28, 110, 111, 0.7));
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 12px;
      }
      #status {
        font-size: 11px;
        color: #334155;
      }
      #viewerContainer {
        flex: 1;
        overflow: auto;
        background: #e6ecf2;
      }
      .pdfViewer .page {
        margin: 12px auto;
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18);
        background: #fff;
      }
    </style>
  </head>
  <body>
    <div id="toolbar">
      <button id="highlight-btn">Highlight selection</button>
      <span id="status">Select text and click highlight.</span>
      <a id="open-pdf-link" href="#" target="_blank" rel="noreferrer">Open PDF</a>
    </div>
    <div id="viewerContainer">
      <div id="viewer" class="pdfViewer"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const fileUrl = params.get("file");
      const docId = params.get("doc_id");
      const isEmbed = params.get("embed") === "1";
      const statusEl = document.getElementById("status");
      const openLink = document.getElementById("open-pdf-link");
      const viewerContainer = document.getElementById("viewerContainer");
      const viewer = document.getElementById("viewer");

      function showFallback(url, message) {
        statusEl.textContent = message || "PDF fallback.";
        if (!url) {
          viewerContainer.innerHTML =
            "<div style='padding:16px;color:#94a3b8;'>No PDF to display.</div>";
          return;
        }
        if (openLink) {
          openLink.href = url;
        }
        const embed = document.createElement("embed");
        embed.src = url;
        embed.type = "application/pdf";
        embed.style.border = "none";
        embed.style.width = "100%";
        embed.style.height = "100%";
        viewerContainer.innerHTML = "";
        viewerContainer.appendChild(embed);
      }

      if (isEmbed && openLink) {
        openLink.style.display = "none";
      }
      if (!fileUrl) {
        showFallback("", "No PDF selected.");
      }

      let pdfViewer = null;
      let linkService = null;
      let pagesReady = false;
      let loadTimeout = null;
      let lastSelection = null;

      if (!window.pdfjsLib || !window.pdfjsViewer) {
        showFallback(fileUrl, "PDF.js unavailable, using browser fallback.");
      } else {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
        pdfjsLib.disableWorker = true;

        const eventBus = new pdfjsViewer.EventBus();
        linkService = new pdfjsViewer.PDFLinkService({ eventBus });
        pdfViewer = new pdfjsViewer.PDFViewer({
          container: viewerContainer,
          viewer,
          eventBus,
          linkService,
          textLayerMode: 2,
        });
        linkService.setViewer(pdfViewer);

        eventBus.on("pagesinit", () => {
          pagesReady = true;
          if (loadTimeout) {
            clearTimeout(loadTimeout);
            loadTimeout = null;
          }
          pdfViewer.currentScaleValue = "page-width";
        });

        eventBus.on("pagesloaded", () => {
          pagesReady = true;
          if (loadTimeout) {
            clearTimeout(loadTimeout);
            loadTimeout = null;
          }
        });
      }

      function loadPdf(url) {
        if (!url) {
          showFallback("", "No PDF selected.");
          return;
        }
        if (!window.pdfjsLib || !window.pdfjsViewer || !pdfViewer || !linkService) {
          showFallback(url, "PDF.js unavailable, using browser fallback.");
          return;
        }
        if (openLink) {
          openLink.href = url;
        }
        pagesReady = false;
        if (loadTimeout) {
          clearTimeout(loadTimeout);
          loadTimeout = null;
        }
        let loadingTask = null;
        try {
          loadingTask = pdfjsLib.getDocument({
            url,
            disableRange: true,
            disableStream: true,
            disableAutoFetch: true,
          });
        } catch (err) {
          showFallback(url, `PDF.js error: ${err}`);
          return;
        }
        loadingTask.promise
          .then((pdf) => {
            pdfViewer.setDocument(pdf);
            linkService.setDocument(pdf, null);
            statusEl.textContent = "PDF loaded.";
          })
          .catch((err) => {
            showFallback(url, `Failed to load PDF: ${err}`);
          });
        loadTimeout = window.setTimeout(() => {
          const hasCanvas = viewer && viewer.querySelector("canvas");
          if (!pagesReady || !hasCanvas) {
            showFallback(url, "PDF.js timed out, using browser fallback.");
          }
        }, 4500);
      }

      function isInViewer(node) {
        return node && viewerContainer && viewerContainer.contains(node);
      }

      function findPageNode(node) {
        let current = node;
        while (current && current !== document) {
          if (current.classList && current.classList.contains("page")) {
            return current;
          }
          current = current.parentNode;
        }
        return null;
      }

      function normalizeSelectionText(text) {
        if (!text) return "";
        return text
          .replace(/\u00ad/g, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      function getSelectionInfo(selection) {
        const rawText = selection ? selection.toString() : "";
        const text = normalizeSelectionText(rawText);
        if (!text) return null;
        let node = selection.anchorNode || selection.focusNode;
        if (!isInViewer(node)) {
          const range = selection.rangeCount ? selection.getRangeAt(0) : null;
          node = range ? range.commonAncestorContainer : node;
        }
        if (!isInViewer(node)) return null;
        let pageNode = findPageNode(node);
        let page = pdfViewer && pdfViewer.currentPageNumber ? pdfViewer.currentPageNumber : 1;
        if (pageNode && pageNode.dataset && pageNode.dataset.pageNumber) {
          const parsed = parseInt(pageNode.dataset.pageNumber, 10);
          if (!Number.isNaN(parsed)) {
            page = parsed;
          }
        }
        return { text, page };
      }

      function captureSelection() {
        const selection = window.getSelection();
        const info = getSelectionInfo(selection);
        if (info) {
          lastSelection = info;
        }
      }

      async function highlightSelection() {
        const selection = window.getSelection();
        const info = getSelectionInfo(selection) || lastSelection;
        if (!info) {
          statusEl.textContent = "Select text first.";
          return;
        }
        if (!docId) {
          statusEl.textContent = "Missing document id.";
          return;
        }
        statusEl.textContent = "Highlighting...";
        try {
          const response = await fetch("/pdf_highlight", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              doc_id: docId,
              text: info.text,
              page: info.page,
            }),
          });
          const data = await response.json();
          statusEl.textContent = data.message || "Done.";
          if (data.success) {
            const cacheBust = Date.now();
            const nextUrl = fileUrl.includes("?")
              ? `${fileUrl}&v=${cacheBust}`
              : `${fileUrl}?v=${cacheBust}`;
            loadPdf(nextUrl);
          }
        } catch (err) {
          statusEl.textContent = `Highlight failed: ${err}`;
        }
      }

      document
        .getElementById("highlight-btn")
        .addEventListener("click", highlightSelection);
      document.addEventListener("selectionchange", captureSelection);
      viewerContainer.addEventListener("mouseup", captureSelection);
      window.addEventListener("error", (event) => {
        showFallback(fileUrl, `Viewer error: ${event.message || "Unknown error"}`);
      });
      window.addEventListener("unhandledrejection", (event) => {
        showFallback(fileUrl, `Viewer error: ${event.reason || "Unknown error"}`);
      });

      loadPdf(fileUrl);
    </script>
  </body>
</html>
